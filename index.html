<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hattriX Simulation - Hattrick Lineup Simulator by IanMajor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: system-ui, sans-serif; background: #1f2937; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script type="text/babel">
        const { Users, Home, Shirt, X, Heart, Plus, Trash2, Edit2, Upload, Download } = lucide;
        const { useState, useEffect } = React;

const LineupSimulator = () => {
  const [selectedFormation, setSelectedFormation] = useState('3-5-2');
  const [draggedPlayer, setDraggedPlayer] = useState(null); // { player, fromSlotId }
  const [editingPlayer, setEditingPlayer] = useState(null);
  const [tacticLevel, setTacticLevel] = useState(0);
  const [isDraggingSlider, setIsDraggingSlider] = useState(false);
  const [selectedTactic, setSelectedTactic] = useState('Normal');
  const [selectedWeather, setSelectedWeather] = useState('partly-cloudy');
  const [selectedVenue, setSelectedVenue] = useState('Away');
  const [selectedTeamSpirit, setSelectedTeamSpirit] = useState(5.5);
  const [selectedConfidence, setSelectedConfidence] = useState(5.5);
  const [teamAttitude, setTeamAttitude] = useState('Normal');
  const [playerOrders, setPlayerOrders] = useState({});
  
  // Rating calculation state
  const [ratings, setRatings] = useState({
    centralDefense: 0.92,
    leftDefense: 0.92,
    rightDefense: 0.92,
    midfield: 0.92,
    leftAttack: 0.92,
    centralAttack: 0.92,
    rightAttack: 0.92
  });
  
  // Download: Speichere alle Daten als JSON
  const downloadData = () => {
    const data = {
      players,
      lineup,
      playerOrders,
      teamAttitude,
      selectedVenue,
      selectedWeather,
      selectedTeamSpirit,
      selectedConfidence,
      tacticLevel,
      selectedFormation
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hattrick-lineup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Upload: Lade Daten aus JSON
  const uploadData = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Restore all data
        if (data.players) setPlayers(data.players);
        if (data.lineup) setLineup(data.lineup);
        if (data.playerOrders) setPlayerOrders(data.playerOrders);
        if (data.teamAttitude) setTeamAttitude(data.teamAttitude);
        if (data.selectedVenue) setSelectedVenue(data.selectedVenue);
        if (data.selectedWeather) setSelectedWeather(data.selectedWeather);
        if (data.selectedTeamSpirit !== undefined) setSelectedTeamSpirit(data.selectedTeamSpirit);
        if (data.selectedConfidence !== undefined) setSelectedConfidence(data.selectedConfidence);
        if (data.tacticLevel !== undefined) setTacticLevel(data.tacticLevel);
        if (data.selectedFormation) setSelectedFormation(data.selectedFormation);
        
        alert('Data loaded successfully!');
      } catch (error) {
        alert('Error loading data: ' + error.message);
      }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset input
  };

  const [players, setPlayers] = useState([
    { 
      id: 1, 
      name: 'Player 1',
      age: { years: 19, days: 0 },
      tsi: 0,
      specialty: 'None',
      form: 7.0,
      stamina: 7.0,
      experience: 3.0,
      loyalty: 0.0,
      homegrown: false,
      skills: {
        keeper: { level: 'poor', value: 3 },
        defending: { level: 'poor', value: 3 },
        playmaking: { level: 'poor', value: 3 },
        winger: { level: 'poor', value: 3 },
        passing: { level: 'poor', value: 3 },
        scoring: { level: 'poor', value: 3 },
        setPieces: { level: 'poor', value: 3 }
      }
    }
  ]);
  
  // Ermittle beste Position basierend auf Skills
  const getBestPosition = (player) => {
    const skills = player.skills;
    
    // Finde höchsten Skill-Wert
    const skillValues = {
      keeper: skills.keeper.value,
      defending: skills.defending.value,
      playmaking: skills.playmaking.value,
      winger: skills.winger.value,
      passing: skills.passing.value,
      scoring: skills.scoring.value
    };
    
    const maxValue = Math.max(...Object.values(skillValues));
    
    // Prüfe ob alle gleich sind
    const allEqual = Object.values(skillValues).every(v => v === maxValue);
    if (allEqual) return null;
    
    // Bestimme Position basierend auf höchstem Skill
    if (skillValues.keeper === maxValue) return 'GK';
    if (skillValues.defending === maxValue) return 'CD';
    if (skillValues.playmaking === maxValue) return 'IM';
    if (skillValues.winger === maxValue) return 'W';
    
    // Für FW: Scoring + Passing kombiniert
    const fwScore = skillValues.scoring + skillValues.passing;
    const otherMax = Math.max(
      skillValues.defending,
      skillValues.playmaking,
      skillValues.winger
    );
    
    if (skillValues.scoring === maxValue || skillValues.passing === maxValue) {
      if (fwScore > otherMax * 1.5) return 'FW';
    }
    
    return null;
  };

  // Icon für Specialty
  const getSpecialtyIcon = (specialty) => {
    const letters = {
      'Technical': 'T',
      'Quick': 'Q',
      'Powerful': 'P',
      'Unpredictable': 'U',
      'Head': 'H',
      'Resilient': 'R',
      'Support': 'S'
    };
    return letters[specialty] || null;
  };
  
  const getSpecialtyColor = (specialty) => {
    // Verschiedene Grüntöne für verschiedene Specialties
    const colors = {
      'Technical': 'bg-green-600',
      'Quick': 'bg-green-700',
      'Powerful': 'bg-green-800',
      'Unpredictable': 'bg-teal-600',
      'Head': 'bg-emerald-600',
      'Resilient': 'bg-lime-700',
      'Support': 'bg-cyan-700'
    };
    return colors[specialty] || 'bg-green-600';
  };
  
  const [nextPlayerId, setNextPlayerId] = useState(2);
  const [uploadError, setUploadError] = useState(null);

  const [lineup, setLineup] = useState({
    'slot-gk-1': { position: 'GK', x: 50, y: 8, player: null },
    'slot-wb-1': { position: 'WB', x: 92, y: 28, player: null },  // Links -> x: 92
    'slot-cd-1': { position: 'CD', x: 70, y: 28, player: null },  // Links -> x: 70
    'slot-cd-2': { position: 'CD', x: 50, y: 28, player: null },
    'slot-cd-3': { position: 'CD', x: 30, y: 28, player: null },  // Rechts -> x: 30
    'slot-wb-2': { position: 'WB', x: 8, y: 28, player: null },   // Rechts -> x: 8
    'slot-w-1': { position: 'W', x: 92, y: 52, player: null },    // Links -> x: 92
    'slot-cm-1': { position: 'IM', x: 68, y: 52, player: null },  // Links -> x: 68
    'slot-cm-2': { position: 'IM', x: 50, y: 52, player: null },
    'slot-cm-3': { position: 'IM', x: 32, y: 52, player: null },  // Rechts -> x: 32
    'slot-w-2': { position: 'W', x: 8, y: 52, player: null },     // Rechts -> x: 8
    'slot-fw-1': { position: 'FW', x: 72, y: 75, player: null },  // Links -> x: 72
    'slot-fw-2': { position: 'FW', x: 50, y: 75, player: null },
    'slot-fw-3': { position: 'FW', x: 28, y: 75, player: null },  // Rechts -> x: 28
  });

  const formations = {
    '3-5-2': [
      { id: 'slot-gk-1', position: 'GK', x: 50, y: 8 },
      { id: 'slot-wb-1', position: 'WB', x: 92, y: 28 },
      { id: 'slot-cd-1', position: 'CD', x: 70, y: 28 },
      { id: 'slot-cd-2', position: 'CD', x: 50, y: 28 },
      { id: 'slot-cd-3', position: 'CD', x: 30, y: 28 },
      { id: 'slot-wb-2', position: 'WB', x: 8, y: 28 },
      { id: 'slot-w-1', position: 'W', x: 92, y: 52 },
      { id: 'slot-cm-1', position: 'IM', x: 68, y: 52 },
      { id: 'slot-cm-2', position: 'IM', x: 50, y: 52 },
      { id: 'slot-cm-3', position: 'IM', x: 32, y: 52 },
      { id: 'slot-w-2', position: 'W', x: 8, y: 52 },
      { id: 'slot-fw-1', position: 'FW', x: 72, y: 75 },
      { id: 'slot-fw-2', position: 'FW', x: 50, y: 75 },
      { id: 'slot-fw-3', position: 'FW', x: 28, y: 75 },
    ],
  };

  const getSkillColor = (level) => {
    const colors = {
      'non-existent': 'text-gray-400',
      'disastrous': 'text-red-700',
      'wretched': 'text-red-600',
      'poor': 'text-red-500',
      'weak': 'text-orange-600',
      'inadequate': 'text-orange-500',
      'passable': 'text-yellow-600',
      'solid': 'text-green-600',
      'excellent': 'text-green-500',
      'formidable': 'text-green-400',
      'outstanding': 'text-teal-500',
      'brilliant': 'text-teal-400',
      'magnificent': 'text-cyan-400',
      'world class': 'text-blue-400',
      'supernatural': 'text-blue-300',
      'titanic': 'text-indigo-400',
      'extra-terrestrial': 'text-purple-400',
      'mythical': 'text-purple-300',
      'magical': 'text-pink-400',
      'utopian': 'text-pink-300',
      'divine': 'text-yellow-300'
    };
    return colors[level] || 'text-gray-500';
  };

  const handleSliderMouseDown = (e) => {
    setIsDraggingSlider(true);
    const sliderElement = document.getElementById('tactic-slider');
    if (sliderElement) {
      const rect = sliderElement.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const percentage = Math.max(0, Math.min(1, y / rect.height));
      const value = Math.round((percentage * 200 - 100) / 10) * 10;
      setTacticLevel(value);
    }
  };

  useEffect(() => {
    if (isDraggingSlider) {
      const handleMouseMove = (e) => {
        const sliderElement = document.getElementById('tactic-slider');
        if (sliderElement) {
          const rect = sliderElement.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const percentage = Math.max(0, Math.min(1, y / rect.height));
          const value = Math.round((percentage * 200 - 100) / 10) * 10;
          setTacticLevel(value);
        }
      };

      const handleMouseUp = () => {
        setIsDraggingSlider(false);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDraggingSlider]);

  const addNewPlayer = () => {
    const newPlayer = {
      id: nextPlayerId,
      name: `Player ${nextPlayerId}`,
      age: { years: 19, days: 0 },
      tsi: 0,
      specialty: 'None',
      form: 7.0,
      stamina: 7.0,
      experience: 3.0,
      loyalty: 0.0,
      homegrown: false,
      skills: {
        keeper: { level: 'poor', value: 3 },
        defending: { level: 'poor', value: 3 },
        playmaking: { level: 'poor', value: 3 },
        winger: { level: 'poor', value: 3 },
        passing: { level: 'poor', value: 3 },
        scoring: { level: 'poor', value: 3 },
        setPieces: { level: 'poor', value: 3 }
      }
    };
    setPlayers(prev => [...prev, newPlayer]);
    setNextPlayerId(prev => prev + 1);
  };

  const deletePlayer = (playerId) => {
    setLineup(prev => {
      const newLineup = { ...prev };
      Object.keys(newLineup).forEach(slotId => {
        if (newLineup[slotId].player?.id === playerId) {
          newLineup[slotId].player = null;
        }
      });
      return newLineup;
    });
    setPlayers(prev => prev.filter(p => p.id !== playerId));
  };

  const getSkillLevelNameFromValue = (value) => {
    const levels = [
      'non-existent', 'disastrous', 'wretched', 'poor', 'weak', 'inadequate',
      'passable', 'solid', 'excellent', 'formidable', 'outstanding',
      'brilliant', 'magnificent', 'world class', 'supernatural', 'titanic',
      'extra-terrestrial', 'mythical', 'magical', 'utopian', 'divine'
    ];
    const index = Math.min(Math.floor(value), 20);
    return levels[index] || 'non-existent';
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    setUploadError(null);

    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());
      
      console.log(`Total lines in file: ${lines.length}`);
      
      if (lines.length < 2) {
        setUploadError('File must contain at least a header row and one data row');
        return;
      }

      // Detect delimiter (tab or comma or semicolon)
      let delimiter = ',';
      if (lines[0].includes('\t')) delimiter = '\t';
      else if (lines[0].includes(';')) delimiter = ';';
      
      console.log(`Using delimiter: "${delimiter}"`);
      console.log(`First line: ${lines[0].substring(0, 100)}...`);
      
      const newPlayers = [];
      let maxId = Math.max(...players.map(p => p.id), 0);

      // Skip header row, start from line 1
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Split by delimiter, handling quoted values and replacing comma decimals with dots
        const values = line.split(delimiter).map(v => {
          let cleaned = v.trim().replace(/^"|"$/g, '');
          // Replace comma with dot for decimal numbers
          cleaned = cleaned.replace(',', '.');
          return cleaned;
        });
        
        console.log(`Line ${i}: ${values.length} columns`);
        
        if (values.length < 37) {
          console.warn(`Skipping line ${i}: insufficient columns (${values.length} columns found, need at least 37)`);
          console.log(`Line content: ${line.substring(0, 100)}...`);
          continue;
        }

        maxId++;
        
        // Map specialty number to name
        const specialtyMap = {
          '0': 'None',
          '1': 'Technical',
          '2': 'Quick',
          '3': 'Powerful',
          '4': 'Unpredictable',
          '5': 'Head',
          '6': 'Resilient',
          '8': 'Support'
        };
        
        // Build full name from FirstName, NickName, LastName
        const firstName = values[1] || '';   // Column 1
        const nickName = values[2] || '';    // Column 2
        const lastName = values[3] || '';    // Column 3
        let fullName = firstName;
        if (nickName) fullName += ` "${nickName}"`;
        if (lastName) fullName += ` ${lastName}`;
        fullName = fullName.trim() || `Player ${maxId}`;
        
        console.log(`Creating player: ${fullName}`);
        
        const playerData = {
          id: maxId,
          name: fullName,
          age: { 
            years: parseInt(values[4]) || 20,   // Age (column 4) = 20
            days: parseInt(values[5]) || 0       // Age Days (column 5) = 96
          },
          tsi: parseInt(values[6]) || 0,         // TSI (column 6) = 61540
          specialty: specialtyMap[values[26]] || 'None',  // Speciality (column 26) = 2
          form: parseFloat(values[28]) || 5.0,             // Form (column 28) = 6
          stamina: parseFloat(values[29]) || 5.0,          // Stamina (column 29) = 8
          experience: parseFloat(values[24]) || 5.0,       // Experience (column 24) = 4
          loyalty: parseFloat(values[23]) || 0.0,          // Loyalty (column 23) = 20 - KORRIGIERT zu 0.0
          homegrown: false,
          skills: {
            keeper: { value: Math.round(parseFloat(values[30]) * 10) / 10 || 5 },      // Keeper (column 30)
            defending: { value: Math.round(parseFloat(values[35]) * 10) / 10 || 5 },   // Defending (column 35)
            playmaking: { value: Math.round(parseFloat(values[31]) * 10) / 10 || 5 },  // Playmaking (column 31)
            winger: { value: Math.round(parseFloat(values[34]) * 10) / 10 || 5 },      // Winger (column 34)
            passing: { value: Math.round(parseFloat(values[33]) * 10) / 10 || 5 },     // Passing (column 33)
            scoring: { value: Math.round(parseFloat(values[32]) * 10) / 10 || 5 },     // Scoring (column 32)
            setPieces: { value: Math.round(parseFloat(values[36]) * 10) / 10 || 5 }    // Set Pieces (column 36)
          }
        };

        // Update skill levels based on values
        Object.keys(playerData.skills).forEach(skillName => {
          const value = playerData.skills[skillName].value;
          playerData.skills[skillName].level = getSkillLevelNameFromValue(value);
        });

        newPlayers.push(playerData);
      }

      console.log(`Created ${newPlayers.length} players`);

      if (newPlayers.length === 0) {
        setUploadError('No valid player data found in file. Check browser console for details.');
        return;
      }

      setPlayers(prev => [...prev, ...newPlayers]);
      setNextPlayerId(maxId + 1);
      event.target.value = '';
      
      // Clear error and show success
      setUploadError(null);
      console.log(`Successfully imported ${newPlayers.length} players`);
      
    } catch (error) {
      setUploadError('Error reading file: ' + error.message);
      console.error('Upload error:', error);
    }
  };

  const exportPlayers = () => {
    const headers = [
      'Name', 'Age_Years', 'Age_Days', 'TSI', 'Specialty', 'Form', 'Stamina',
      'Experience', 'Loyalty', 'Homegrown', 'Keeper', 'Defending', 'Playmaking',
      'Winger', 'Passing', 'Scoring', 'SetPieces'
    ];

    const rows = players.map(p => [
      p.name,
      p.age.years,
      p.age.days,
      p.tsi,
      p.specialty,
      p.form,
      p.stamina,
      p.experience,
      p.loyalty,
      p.homegrown ? 'true' : 'false',
      p.skills.keeper.value,
      p.skills.defending.value,
      p.skills.playmaking.value,
      p.skills.winger.value,
      p.skills.passing.value,
      p.skills.scoring.value,
      p.skills.setPieces.value
    ]);

    const tsvContent = [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
    const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'players.tsv';
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleDragStart = (player, fromSlotId = null) => {
    setDraggedPlayer({ player, fromSlotId });
  };

  const handleDrop = (toSlotId) => {
    if (!draggedPlayer) return;
    
    const { player, fromSlotId } = draggedPlayer;
    
    setLineup(prev => {
      const newLineup = { ...prev };
      
      // Speichere den Spieler der auf dem Ziel-Slot ist (falls vorhanden)
      const playerOnTargetSlot = prev[toSlotId]?.player;
      
      // Wenn der Spieler von einer anderen Position kommt
      if (fromSlotId && fromSlotId !== toSlotId) {
        // Wenn auf dem Ziel-Slot ein Spieler ist, tausche die Plätze
        if (playerOnTargetSlot) {
          newLineup[fromSlotId] = {
            ...prev[fromSlotId],
            player: playerOnTargetSlot
          };
        } else {
          // Sonst entferne einfach vom alten Slot
          newLineup[fromSlotId] = {
            ...prev[fromSlotId],
            player: null
          };
        }
      }
      
      // Setze Spieler auf die neue Position
      newLineup[toSlotId] = {
        ...prev[toSlotId],
        player: player
      };
      
      return newLineup;
    });
    
    setDraggedPlayer(null);
  };

  const handleRemovePlayer = (slotId) => {
    setLineup(prev => ({
      ...prev,
      [slotId]: {
        ...prev[slotId],
        player: null
      }
    }));
  };

  const setPlayerOrder = (slotId, order) => {
    setPlayerOrders(prev => ({
      ...prev,
      [slotId]: order
    }));
  };

  const getOrderArrow = (order, slotId) => {
    switch(order) {
      case 'Def': return '↑';
      case 'Off': return '↓';
      case 'TW': {
        // TW = Toward Wing: CD/IM/FW nach außen zum Flügel
        // Linke Positionen (CD 1, IM 1, FW 1): nach rechts → (angezeigter Pfeil)
        // Rechte Positionen (CD 3, IM 3, FW 3): nach links ← (angezeigter Pfeil)
        const isLeft = slotId === 'slot-cd-1' || slotId === 'slot-cm-1' || slotId === 'slot-fw-1';
        return isLeft ? '→' : '←';
      }
      case 'TM': {
        // TM = Toward Middle: WB/W nach innen zur Mitte
        // Linker WB/W: nach rechts → (zur Mitte - angezeigter Pfeil)
        // Rechter WB/W: nach links ← (zur Mitte - angezeigter Pfeil)
        const isLeft = slotId === 'slot-wb-1' || slotId === 'slot-w-1';
        return isLeft ? '→' : '←';
      }
      default: return '';
    }
  };

  const getOrderColor = (order) => {
    return 'text-yellow-400';
  };

  const changeFormation = (formation) => {
    const newLineup = {};
    formations[formation].forEach(slot => {
      newLineup[slot.id] = {
        position: slot.position,
        x: slot.x,
        y: slot.y,
        player: null
      };
    });
    setLineup(newLineup);
    setSelectedFormation(formation);
  };

  // Berechne die aktuelle Formation basierend auf aufgestellten Spielern
  const calculateCurrentFormation = () => {
    let defenders = 0;
    let midfielders = 0;
    let forwards = 0;

    Object.entries(lineup).forEach(([slotId, slotData]) => {
      if (slotData.player) {
        const pos = slotData.position;
        if (pos === 'WB' || pos === 'CD') {
          defenders++;
        } else if (pos === 'IM' || pos === 'W') {
          midfielders++;
        } else if (pos === 'FW') {
          forwards++;
        }
        // GK wird nicht gezählt
      }
    });

    // Wenn keine Spieler aufgestellt sind, gib null zurück
    if (defenders === 0 && midfielders === 0 && forwards === 0) {
      return null;
    }

    return `${defenders}-${midfielders}-${forwards}`;
  };

  // Calculate ratings whenever lineup or modifiers change
  useEffect(() => {
    calculateRatings();
  }, [lineup, selectedTactic, tacticLevel, selectedWeather, selectedVenue, selectedTeamSpirit, selectedConfidence, teamAttitude, playerOrders]);

  const calculateRatings = () => {
    // ========================================================================
    // PRÄZISE RATING-BERECHNUNG BASIEREND AUF DER HATTRICK-FORSCHUNG
    // ========================================================================
    
    // OverCrowding Penalty berechnen
    const getOverCrowdingPenalty = (slotId) => {
      const position = lineup[slotId]?.position;
      if (!position) return 1.0;
      
      // Zähle wie viele Spieler auf derselben Position sind
      let count = 0;
      Object.entries(lineup).forEach(([slot, data]) => {
        if (data.player && data.position === position) {
          count++;
        }
      });
      
      // OverCrowding Penalties aus der Forschung
      if (position === 'CD') {
        if (count === 2) return 0.95;
        if (count === 3) return 0.88;
      } else if (position === 'IM') {
        if (count === 2) return 0.91;
        if (count === 3) return 0.80;
      } else if (position === 'FW') {
        if (count === 2) return 0.93;
        if (count === 3) return 0.84;
      }
      
      return 1.0; // Kein Penalty
    };

    // Hilfsfunktion: Konvertiere Skill-Level zu numerischem Wert mit Sublevel
    const skillLevelToValue = (skillValue) => {
      // skillValue ist der SICHTBARE Wert (z.B. 20 für Divine)
      // Aber der interne Wert für Divine beginnt bei 19.01
      // Laut Forschung: "Weak without sublevels might start at 3.01, since 3.00 would still be considered Poor"
      // Formel: sichtbarer Wert - 1 + 0.01
      // Beispiele:
      // - Sichtbar 3 (Poor) → interner Wert 2.01
      // - Sichtbar 4 (Weak) → interner Wert 3.01
      // - Sichtbar 20 (Divine) → interner Wert 19.01
      // - Sichtbar 4.5 (zwischen Weak und Inadequate) → interner Wert 3.51
      
      if (skillValue <= 0) return 0;
      
      const internalValue = (skillValue - 1) + 0.01;
      return internalValue;
    };

    // Form-Effekt: sqrt(form) / sqrt(7)
    // Wichtig: HT Simulator verwendet KEINE Sublevels für Form!
    // Das bedeutet: Form 7 (Solid) wird als 6.01 interpretiert (Min Value)
    const getFormEffect = (form) => {
      if (form <= 0) return 0;
      
      // Konvertiere sichtbare Form zu internem Wert (ohne Sublevels, also Min Value)
      // Form 0 → 0, Form 1 → 0.01, Form 2 → 1.01, Form 3 → 2.01, ..., Form 7 → 6.01
      const internalFormValue = form > 0 ? (form - 1) + 0.01 : 0;
      
      return Math.sqrt(internalFormValue) / Math.sqrt(7);
    };

    // Loyalty-Bonus: loyalty_level / 19
    const getLoyaltyBonus = (loyalty) => {
      return loyalty / 19;
    };

    // Mother Club (Homegrown) Bonus: +0.5
    const getMotherClubBonus = (isHomegrown) => {
      return isHomegrown ? 0.5 : 0;
    };

    // Experience contribution table
    const experienceContribution = [
      0,      // 0: Null
      0.0006, // 1: Disastrous
      0.0555, // 2: Wretched
      0.1065, // 3: Poor
      0.1509, // 4: Weak
      0.1883, // 5: Inadequate
      0.219,  // 6: Passable
      0.2442, // 7: Solid
      0.2647, // 8: Excellent
      0.2821, // 9: Formidable
      0.2964, // 10: Outstanding
      0.3085, // 11: Brilliant
      0.3188, // 12: Magnificent
      0.3276, // 13: World Class
      0.3353, // 14: Supernatural
      0.3421, // 15: Titanic
      0.3479, // 16: Extra-Terrestrial
      0.3532, // 17: Mythical
      0.3579, // 18: Magical
      0.3621, // 19: Utopian
      0.3659  // 20: Divine
    ];

    const getExperienceEffect = (experience) => {
      const expLevel = Math.floor(experience);
      if (expLevel >= 0 && expLevel < experienceContribution.length) {
        return experienceContribution[expLevel];
      }
      return 0;
    };

    // Position-Order Koeffizienten
    const positionCoefficients = {
      centralDefense: {
        'GK-N': { defense: 0.2625, goalkeeping: 0.65 },
        'WB-Off': { defense: 0.2625 },
        'WB-Def': { defense: 0.325 },
        'WB-N': { defense: 0.2875 },
        'WB-TM': { defense: 0.525 },
        'Side CD-Off': { defense: 0.55 },
        'Side CD-TW': { defense: 0.5 },
        'Side CD-N': { defense: 0.75 },
        'Middle CD-Off': { defense: 0.55 },
        'Middle CD-N': { defense: 0.75 },
        'W-Off': { defense: 0.1 },
        'W-Def': { defense: 0.1875 },
        'W-N': { defense: 0.15 },
        'W-TM': { defense: 0.1875 },
        'Side IM-Off': { defense: 0.1225 },
        'Side IM-Def': { defense: 0.4375 },
        'Side IM-TW': { defense: 0.25 },
        'Side IM-N': { defense: 0.3 },
        'Middle IM-Off': { defense: 0.1225 },
        'Middle IM-Def': { defense: 0.4375 },
        'Middle IM-N': { defense: 0.3 }
      },
      leftDefense: {
        'GK-N': { defense: 0.2625, goalkeeping: 0.65 },
        'WB-Off': { defense: 0.7875 },
        'WB-Def': { defense: 1.0625 },
        'WB-N': { defense: 0.975 },
        'WB-TM': { defense: 0.8 },
        'Side CD-Off': { defense: 0.425 },
        'Side CD-TW': { defense: 0.8625 },
        'Side CD-N': { defense: 0.55 },
        'Middle CD-Off': { defense: 0.2125 },
        'Middle CD-N': { defense: 0.275 },
        'W-Off': { defense: 0.2375 },
        'W-Def': { defense: 0.65 },
        'W-N': { defense: 0.375 },
        'W-TM': { defense: 0.3125 },
        'Side IM-Off': { defense: 0.095 },
        'Side IM-Def': { defense: 0.2875 },
        'Side IM-TW': { defense: 0.25 },
        'Side IM-N': { defense: 0.2 },
        'Middle IM-Off': { defense: 0.0425 },
        'Middle IM-Def': { defense: 0.14375 },
        'Middle IM-N': { defense: 0.1 }
      },
      rightDefense: {
        'GK-N': { defense: 0.2625, goalkeeping: 0.65 },
        'WB-Off': { defense: 0.7875 },
        'WB-Def': { defense: 1.0625 },
        'WB-N': { defense: 0.975 },
        'WB-TM': { defense: 0.8 },
        'Side CD-Off': { defense: 0.425 },
        'Side CD-TW': { defense: 0.8625 },
        'Side CD-N': { defense: 0.55 },
        'Middle CD-Off': { defense: 0.2125 },
        'Middle CD-N': { defense: 0.275 },
        'W-Off': { defense: 0.2375 },
        'W-Def': { defense: 0.65 },
        'W-N': { defense: 0.375 },
        'W-TM': { defense: 0.3125 },
        'Side IM-Off': { defense: 0.095 },
        'Side IM-Def': { defense: 0.2875 },
        'Side IM-TW': { defense: 0.25 },
        'Side IM-N': { defense: 0.2 },
        'Middle IM-Off': { defense: 0.0425 },
        'Middle IM-Def': { defense: 0.14375 },
        'Middle IM-N': { defense: 0.1 }
      },
      midfield: {
        'WB-Off': { playmaking: 0.1 },
        'WB-Def': { playmaking: 0.05 },
        'WB-N': { playmaking: 0.075 },
        'WB-TM': { playmaking: 0.1 },
        'Side CD-Off': { playmaking: 0.2 },
        'Side CD-TW': { playmaking: 0.075 },
        'Side CD-N': { playmaking: 0.125 },
        'Middle CD-Off': { playmaking: 0.2 },
        'Middle CD-N': { playmaking: 0.125 },
        'W-Off': { playmaking: 0.15 },
        'W-Def': { playmaking: 0.15 },
        'W-N': { playmaking: 0.225 },
        'W-TM': { playmaking: 0.275 },
        'Side IM-Off': { playmaking: 0.475 },
        'Side IM-Def': { playmaking: 0.475 },
        'Side IM-TW': { playmaking: 0.45 },
        'Side IM-N': { playmaking: 0.5 },
        'Middle IM-Off': { playmaking: 0.475 },
        'Middle IM-Def': { playmaking: 0.475 },
        'Middle IM-N': { playmaking: 0.5 },
        'Side FW-Def': { playmaking: 0.175 },
        'Side FW-TW': { playmaking: 0.075 },
        'Side FW-N': { playmaking: 0.125 },
        'Middle FW-Def': { playmaking: 0.175 },
        'Middle FW-N': { playmaking: 0.125 }
      },
      centralAttack: {
        'W-Off': { passing: 0.1 },
        'W-Def': { passing: 0.0375 },
        'W-N': { passing: 0.0875 },
        'W-TM': { passing: 0.125 },
        'Side IM-Off': { scoring: 0.25, passing: 0.395 },
        'Side IM-Def': { scoring: 0.1, passing: 0.14 },
        'Side IM-TW': { passing: 0.185 },
        'Side IM-N': { scoring: 0.175, passing: 0.2625 },
        'Middle IM-Off': { scoring: 0.25, passing: 0.395 },
        'Middle IM-Def': { scoring: 0.1, passing: 0.14 },
        'Middle IM-N': { scoring: 0.175, passing: 0.2625 },
        'Side FW-Def': { scoring: 0.45, passing: 0.425 },
        'Side FW-TW': { scoring: 0.525, passing: 0.1875 },
        'Side FW-N': { scoring: 0.8025, passing: 0.2675 },
        'Middle FW-Def': { scoring: 0.45, passing: 0.425 },
        'Middle FW-N': { scoring: 0.8025, passing: 0.2675 }
      },
      leftAttack: {
        'WB-Off': { winger: 0.675 },
        'WB-Def': { winger: 0.44 },
        'WB-N': { winger: 0.575 },
        'WB-TM': { winger: 0.3425 },
        'Side CD-TW': { winger: 0.25 },
        'W-Off': { winger: 0.975, passing: 0.2875 },
        'W-Def': { winger: 0.675, passing: 0.2 },
        'W-N': { winger: 0.8375, passing: 0.25 },
        'W-TM': { winger: 0.725, passing: 0.15 },
        'Side IM-Off': { passing: 0.35 },
        'Side IM-Def': { passing: 0.14 },
        'Side IM-TW': { winger: 0.575, passing: 0.3 },
        'Side IM-N': { passing: 0.25 },
        'Middle IM-Off': { passing: 0.175 },
        'Middle IM-Def': { passing: 0.07 },
        'Middle IM-N': { passing: 0.125 },
        'Side FW-Def': { winger: 0.125, passing: 0.3, scoring: 0.125 },
        'Side FW-TW': { winger: 0.625, passing: 0.2, scoring: 0.5 },
        'Side FW-N': { winger: 0.2375, passing: 0.1325, scoring: 0.2675 },
        'Middle FW-Def': { winger: 0.125, passing: 0.3, scoring: 0.125 },
        'Middle FW-N': { winger: 0.2375, passing: 0.1325, scoring: 0.2675 }
      },
      rightAttack: {
        'WB-Off': { winger: 0.675 },
        'WB-Def': { winger: 0.44 },
        'WB-N': { winger: 0.575 },
        'WB-TM': { winger: 0.3425 },
        'Side CD-TW': { winger: 0.25 },
        'W-Off': { winger: 0.975, passing: 0.2875 },
        'W-Def': { winger: 0.675, passing: 0.2 },
        'W-N': { winger: 0.8375, passing: 0.25 },
        'W-TM': { winger: 0.725, passing: 0.15 },
        'Side IM-Off': { passing: 0.35 },
        'Side IM-Def': { passing: 0.14 },
        'Side IM-TW': { winger: 0.575, passing: 0.3 },
        'Side IM-N': { passing: 0.25 },
        'Middle IM-Off': { passing: 0.175 },
        'Middle IM-Def': { passing: 0.07 },
        'Middle IM-N': { passing: 0.125 },
        'Side FW-Def': { winger: 0.125, passing: 0.3, scoring: 0.125 },
        'Side FW-TW': { winger: 0.625, passing: 0.2, scoring: 0.5 },
        'Side FW-N': { winger: 0.2375, passing: 0.1325, scoring: 0.2675 },
        'Middle FW-Def': { winger: 0.125, passing: 0.3, scoring: 0.125 },
        'Middle FW-N': { winger: 0.2375, passing: 0.1325, scoring: 0.2675 }
      }
    };

    // Sektor-Koeffizienten
    const sectorCoefficients = {
      centralDefense: 0.6716368,
      leftDefense: 0.78204,
      rightDefense: 0.78204,
      midfield: 1.0,
      centralAttack: 0.628456,
      leftAttack: 0.628456,
      rightAttack: 0.628456
    };

    // Helper: Erstelle den richtigen Position-Key für die Koeffizienten-Tabellen
    // Unterscheidet zwischen Side/Middle Positionen
    const getPositionKey = (slotId, order) => {
      const position = lineup[slotId]?.position;
      if (!position) return null;
      
      // GK ist immer gleich
      if (position === 'GK') return 'GK-N';
      
      // WB ist immer gleich
      if (position === 'WB') return `WB-${order}`;
      
      // CD: Unterscheide zwischen Side (links/rechts) und Middle (zentral)
      if (position === 'CD') {
        if (slotId === 'slot-cd-2') {
          // Middle CD
          return `Middle CD-${order}`;
        } else {
          // Side CD (links oder rechts)
          return `Side CD-${order}`;
        }
      }
      
      // W (Winger) ist immer gleich
      if (position === 'W') return `W-${order}`;
      
      // IM: Unterscheide zwischen Side (links/rechts) und Middle (zentral)
      if (position === 'IM') {
        if (slotId === 'slot-cm-2') {
          // Middle IM
          return `Middle IM-${order}`;
        } else {
          // Side IM (links oder rechts)
          return `Side IM-${order}`;
        }
      }
      
      // FW: Unterscheide zwischen Side (links/rechts) und Middle (zentral)
      if (position === 'FW') {
        if (slotId === 'slot-fw-2') {
          // Middle FW
          return `Middle FW-${order}`;
        } else {
          // Side FW (links oder rechts)
          return `Side FW-${order}`;
        }
      }
      
      return `${position}-${order}`;
    };

    // Mapping: slotId -> sector(s) die beeinflusst werden
    // Basierend auf den Koeffizienten-Tabellen aus der Forschung
    const getAffectedSectors = (slotId) => {
      // GK beeinflusst nur Defense-Sektoren (hat Koeffizienten in Central, Left und Right Defense)
      if (slotId === 'slot-gk-1') {
        return ['centralDefense', 'leftDefense', 'rightDefense'];
      }
      
      // Linker WB
      if (slotId === 'slot-wb-1') {
        // Central Defense: Ja (0.2625-0.525)
        // Left Defense: Ja (0.44-1.0625)
        // Right Defense: NEIN (Opp WB hat keine Werte)
        // Midfield: Ja (0.05-0.1)
        // Left Attack: Ja (0.3425-0.675)
        // Central Attack: NEIN
        // Right Attack: NEIN
        return ['centralDefense', 'leftDefense', 'midfield', 'leftAttack'];
      }
      
      // Rechter WB
      if (slotId === 'slot-wb-2') {
        return ['centralDefense', 'rightDefense', 'midfield', 'rightAttack'];
      }
      
      // Linker CD
      if (slotId === 'slot-cd-1') {
        // Central Defense: Ja (0.5-0.75) als "Side CD"
        // Left Defense: Ja (0.425-0.8625) als "Side CD"
        // Right Defense: NEIN (Opp Side CD hat keine Werte)
        // Midfield: Ja (0.075-0.2) als "Side CD"
        // Left Attack: Ja (0.25) als "CD-TW"
        // Central Attack: NEIN
        // Right Attack: NEIN
        return ['centralDefense', 'leftDefense', 'midfield', 'leftAttack'];
      }
      
      // Zentraler CD
      if (slotId === 'slot-cd-2') {
        // Central Defense: Ja (0.55-0.75) als "Middle CD"
        // Left Defense: Ja (0.2125-0.275) als "Middle CD"
        // Right Defense: Ja (0.2125-0.275) als "Middle CD"
        // Midfield: Ja (0.125-0.2) als "Middle CD"
        // Central Attack: NEIN
        // Left Attack: NEIN (CD-TW gibt es nur für Side CD)
        // Right Attack: NEIN
        return ['centralDefense', 'leftDefense', 'rightDefense', 'midfield'];
      }
      
      // Rechter CD
      if (slotId === 'slot-cd-3') {
        return ['centralDefense', 'rightDefense', 'midfield', 'rightAttack'];
      }
      
      // Linker W
      if (slotId === 'slot-w-1') {
        // Central Defense: Ja (0.1-0.1875)
        // Left Defense: Ja (0.2375-0.65)
        // Right Defense: NEIN (Opp Wi hat keine Werte)
        // Midfield: Ja (0.15-0.275)
        // Left Attack: Ja (0.675-0.975 + passing)
        // Central Attack: Ja (0.0375-0.125 passing)
        // Right Attack: NEIN
        return ['centralDefense', 'leftDefense', 'midfield', 'leftAttack', 'centralAttack'];
      }
      
      // Rechter W
      if (slotId === 'slot-w-2') {
        return ['centralDefense', 'rightDefense', 'midfield', 'rightAttack', 'centralAttack'];
      }
      
      // Linker IM
      if (slotId === 'slot-cm-1') {
        // Central Defense: Ja (0.1225-0.4375) als "Side IM"
        // Left Defense: Ja (0.095-0.2875) als "Side IM"
        // Right Defense: NEIN (Opp Side IM hat keine Werte)
        // Midfield: Ja (0.45-0.5) als "Side IM"
        // Left Attack: Ja (0.14-0.575 passing/winger)
        // Central Attack: Ja (0.1-0.395 scoring/passing)
        // Right Attack: NEIN
        return ['centralDefense', 'leftDefense', 'midfield', 'leftAttack', 'centralAttack'];
      }
      
      // Zentraler IM
      if (slotId === 'slot-cm-2') {
        // Central Defense: Ja (0.1225-0.4375) als "Middle IM"
        // Left Defense: Ja (0.0425-0.14375) als "Middle IM"
        // Right Defense: Ja (0.0425-0.14375) als "Middle IM"
        // Midfield: Ja (0.475-0.5) als "Middle IM"
        // Central Attack: Ja (0.1-0.395)
        // Left Attack: Ja (0.07-0.175 passing) als "Middle IM"
        // Right Attack: Ja (0.07-0.175 passing) als "Middle IM"
        return ['centralDefense', 'leftDefense', 'rightDefense', 'midfield', 'centralAttack', 'leftAttack', 'rightAttack'];
      }
      
      // Rechter IM
      if (slotId === 'slot-cm-3') {
        return ['centralDefense', 'rightDefense', 'midfield', 'rightAttack', 'centralAttack'];
      }
      
      // Linker FW
      if (slotId === 'slot-fw-1') {
        // Central Defense: NEIN (Side FW hat keine Werte)
        // Left/Right Defense: NEIN
        // Midfield: Ja (0.075-0.175) als "Side FW"
        // Left Attack: Ja (0.125-0.625 winger/passing/scoring)
        // Central Attack: Ja (0.1875-0.525 scoring/passing)
        // Right Attack: NEIN (Opp Side FW hat keine Werte)
        return ['midfield', 'leftAttack', 'centralAttack'];
      }
      
      // Zentraler FW
      if (slotId === 'slot-fw-2') {
        // Midfield: Ja (0.075-0.175) als "Middle FW"
        // Central Attack: Ja (0.2675-0.8025)
        // Left Attack: Ja (0.06-0.3 passing/scoring) als "Middle FW"
        // Right Attack: Ja (0.06-0.3 passing/scoring) als "Middle FW"
        return ['midfield', 'centralAttack', 'leftAttack', 'rightAttack'];
      }
      
      // Rechter FW
      if (slotId === 'slot-fw-3') {
        return ['midfield', 'rightAttack', 'centralAttack'];
      }
      
      return [];
    };

    // Berechne Spieler-Contribution für einen Sektor
    const calculatePlayerContribution = (player, slotId, order, sector) => {
      if (!player) return 0;

      const posKey = getPositionKey(slotId, order || 'N');
      const coeffs = positionCoefficients[sector]?.[posKey];
      
      if (!coeffs) return 0;

      let totalContribution = 0;

      // Für jeden Skill-Typ in den Koeffizienten
      Object.keys(coeffs).forEach(skillType => {
        const coeff = coeffs[skillType];
        if (!coeff) return;

        // Skill mapping
        let skillValue = 0;
        if (skillType === 'defense') skillValue = player.skills.defending?.value || 0;
        else if (skillType === 'goalkeeping') skillValue = player.skills.keeper?.value || 0;
        else if (skillType === 'playmaking') skillValue = player.skills.playmaking?.value || 0;
        else if (skillType === 'winger') skillValue = player.skills.winger?.value || 0;
        else if (skillType === 'passing') skillValue = player.skills.passing?.value || 0;
        else if (skillType === 'scoring') skillValue = player.skills.scoring?.value || 0;

        if (skillValue === 0) return;

        // Step 1: Skill + Bonuses
        const baseSkill = skillLevelToValue(skillValue);
        const mcBonus = getMotherClubBonus(player.homegrown || false);
        const loyaltyBonus = getLoyaltyBonus(player.loyalty || 0);
        const skillTotal = baseSkill + mcBonus + loyaltyBonus;

        // Step 2: Form effect
        const formEffect = getFormEffect(player.form || 7);

        // Step 3: Position-Order coefficient (already have it as 'coeff')

        // Step 4: Overcrowding penalty
        const ocPenalty = getOverCrowdingPenalty(slotId);

        // Skill contribution
        const skillContribution = skillTotal * formEffect * coeff * ocPenalty;

        // Step 5: Experience effect (only if skill contribution > 0)
        const expEffect = skillContribution > 0 ? getExperienceEffect(player.experience || 0) : 0;

        // DEBUG für Central Defense
        if (sector === 'centralDefense' && slotId === 'slot-cd-2') {
          console.log('=== Central Defense CD Debug ===');
          console.log('Skill Type:', skillType);
          console.log('Skill Value (visible):', skillValue);
          console.log('Base Skill (internal):', baseSkill);
          console.log('MC Bonus:', mcBonus);
          console.log('Loyalty Bonus:', loyaltyBonus);
          console.log('Skill Total:', skillTotal);
          console.log('Form Effect:', formEffect);
          console.log('Coefficient:', coeff);
          console.log('Skill Contribution:', skillContribution);
          console.log('Experience Effect:', expEffect);
          console.log('Total for this skill:', skillContribution + expEffect);
        }

        totalContribution += skillContribution + expEffect;
      });

      return totalContribution;
    };

    // Berechne Sektor-Rating
    const calculateSectorRating = (sector) => {
      let totalContribution = 0;

      // Durchlaufe alle Slots
      Object.entries(lineup).forEach(([slotId, slotData]) => {
        if (!slotData.player) return;

        const affectedSectors = getAffectedSectors(slotId);
        if (!affectedSectors.includes(sector)) return;

        const order = playerOrders[slotId] || 'N';
        const contribution = calculatePlayerContribution(slotData.player, slotId, order, sector);
        totalContribution += contribution;
      });

      // Step 6: Sektor-Koeffizient
      const afterSectorCoeff = totalContribution * sectorCoefficients[sector];

      // Step 7: 1.2 Exponent
      const ratingValue = Math.pow(afterSectorCoeff, 1.2);

      // Step 8: Team Modifiers (sektor-spezifisch)
      const teamModifiers = calculateTeamModifiers(sector);
      const finalRating = ratingValue * teamModifiers;

      // DEBUG für Central Defense
      if (sector === 'centralDefense') {
        console.log('=== SECTOR CALCULATION: Central Defense ===');
        console.log('Total Contribution (sum):', totalContribution);
        console.log('Sector Coefficient:', sectorCoefficients[sector]);
        console.log('After Sector Coeff:', afterSectorCoeff);
        console.log('After 1.2 Exponent:', ratingValue);
        console.log('Team Modifiers:', teamModifiers);
        console.log('Final Rating Value:', finalRating);
        console.log('Converted Rating:', convertToRatingLevel(finalRating));
      }

      return convertToRatingLevel(finalRating);
    };

    // Team Spirit - Exakte Lookup-Tabelle aus der Forschung
    const getTeamSpiritEffect = (spiritLevel) => {
      const spiritEffects = {
        10.5: 0.999339, // POE
        9.5: 0.952828,  // WOC
        8.5: 0.903935,  // Delirious
        7.5: 0.852233,  // Satisfied
        6.5: 0.797197,  // Content
        5.5: 0.738048,  // Calm
        4.5: 0.673735,  // Composed
        3.5: 0.602618,  // Irritated
        2.5: 0.521869,  // Furious
        1.5: 0.426106,  // Murderous
        0.5: 0.301306   // like Cold War
      };
      
      return spiritEffects[spiritLevel] || 1.0;
    };

    // Team Modifiers - unterschiedlich je nach Sektor!
    const calculateTeamModifiers = (sector) => {
      let modifier = 1.0;
      
      const isDefenseSector = sector.includes('Defense');
      const isAttackSector = sector.includes('Attack');
      const isMidfieldSector = sector === 'midfield';

      // 1. Team Intensity - NUR für Midfield
      if (isMidfieldSector) {
        const intensityMap = {
          'Match of the Season': 1.1067,
          'Normal': 1.0,
          'Play it cool': 0.8409
        };
        modifier *= intensityMap[teamAttitude] || 1.0;
      }

      // 2. Home/Away/Derby - NUR für Midfield
      if (isMidfieldSector) {
        const venueMap = {
          'Home': 1.0,
          'Away': 0.8333,
          'Neutral': 0.9167
        };
        modifier *= venueMap[selectedVenue] || 1.0;
      }

      // 3. Team Spirit - NUR für Midfield
      if (isMidfieldSector) {
        modifier *= getTeamSpiritEffect(selectedTeamSpirit);
      }

      // 4. Coach Effect - NUR für Defense und Attack Sektoren
      if (isDefenseSector || isAttackSector) {
        const coachLevel = tacticLevel; // -100 bis +100

        if (coachLevel !== 0) {
          const absLevel = Math.abs(coachLevel) / 10; // 0-10
          
          if (coachLevel < 0) {
            // Defensive Coach
            if (isDefenseSector) {
              modifier *= 1.0 + (absLevel * 0.01274685);
            } else if (isAttackSector) {
              modifier *= 1.0 - (absLevel * 0.01176471);
            }
          } else {
            // Offensive Coach
            if (isAttackSector) {
              modifier *= 1.0 + (absLevel * 0.00784507);
            } else if (isDefenseSector) {
              modifier *= 1.0 - (absLevel * 0.01176471);
            }
          }
        }
      }

      // 5. Team Confidence - NUR für Attack Sektoren
      if (isAttackSector) {
        const confidenceMap = {
          0: 0.8,   // non-existent
          1: 0.85,  // disastrous
          2: 0.9,   // wretched
          3: 0.95,  // poor
          4: 1.0,   // decent
          5: 1.05,  // strong
          6: 1.1,   // wonderful
          7: 1.15,  // slightly exaggerated
          8: 1.2,   // exaggerated
          9: 1.25   // completely exaggerated
        };
        const confLevel = Math.floor(selectedConfidence);
        modifier *= confidenceMap[confLevel] || 1.0;
      }

      return modifier;
    };

    // Konvertiere numerischen Wert zu Rating-Level
    // Exakte Tabelle aus der Forschung - jedes Level hat 4 Sublevels
    const convertToRatingLevel = (value) => {
      if (value <= 0) return 0.92; // UI minimum
      
      // Die Formel: Für jeden Block von 4 Values gibt es einen Rating-Level
      // Value 0-1: 1.0, 1-2: 1.25, 2-3: 1.5, 3-4: 1.75
      // Value 4-5: 2.0, 5-6: 2.25, 6-7: 2.5, 7-8: 2.75
      // Pattern: Rating = floor(value/4) + 1 + (value % 4) * 0.25
      
      const baseRating = Math.floor(value / 4) + 1;
      const sublevel = value % 4;
      const sublevelOffset = sublevel * 0.25;
      
      return baseRating + sublevelOffset;
    };

    // Berechne alle Ratings
    const newRatings = {
      leftDefense: calculateSectorRating('leftDefense'),
      centralDefense: calculateSectorRating('centralDefense'),
      rightDefense: calculateSectorRating('rightDefense'),
      midfield: calculateSectorRating('midfield'),
      leftAttack: calculateSectorRating('leftAttack'),
      centralAttack: calculateSectorRating('centralAttack'),
      rightAttack: calculateSectorRating('rightAttack')
    };

    setRatings(newRatings);
  };

  const PlayerEditor = ({ player, onClose }) => {
    const [editedPlayer, setEditedPlayer] = useState({ ...player });
    const [copyFromPlayerId, setCopyFromPlayerId] = useState('');

    const updatePlayer = (field, value) => {
      setEditedPlayer(prev => ({ ...prev, [field]: value }));
    };

    const updateAge = (field, value) => {
      setEditedPlayer(prev => ({
        ...prev,
        age: { ...prev.age, [field]: value }
      }));
    };

    const updateSkill = (skillName, value) => {
      const numValue = parseFloat(value);
      if (!isNaN(numValue) && numValue >= 0 && numValue <= 23) {
        setEditedPlayer(prev => ({
          ...prev,
          skills: {
            ...prev.skills,
            [skillName]: {
              level: getSkillLevelName(numValue),
              value: numValue
            }
          }
        }));
      }
    };

    const copySkillsFrom = (sourcePlayerId) => {
      if (!sourcePlayerId) return;
      
      const sourcePlayer = players.find(p => p.id === parseInt(sourcePlayerId));
      if (!sourcePlayer) return;

      // Copy all relevant attributes
      setEditedPlayer(prev => ({
        ...prev,
        age: { ...sourcePlayer.age },
        tsi: sourcePlayer.tsi,
        specialty: sourcePlayer.specialty,
        form: sourcePlayer.form,
        stamina: sourcePlayer.stamina,
        experience: sourcePlayer.experience,
        loyalty: sourcePlayer.loyalty,
        homegrown: sourcePlayer.homegrown,
        skills: JSON.parse(JSON.stringify(sourcePlayer.skills)) // Deep copy
      }));

      setCopyFromPlayerId('');
    };

    const getSkillLevelName = (value) => {
      const levels = [
        'non-existent', 'disastrous', 'wretched', 'poor', 'weak', 'inadequate',
        'passable', 'solid', 'excellent', 'formidable', 'outstanding',
        'brilliant', 'magnificent', 'world class', 'supernatural', 'titanic',
        'extra-terrestrial', 'mythical', 'magical', 'utopian', 'divine'
      ];
      const index = Math.min(Math.floor(value), 20);
      return levels[index] || 'non-existent';
    };

    const handleSave = () => {
      setPlayers(prev => prev.map(p => p.id === editedPlayer.id ? editedPlayer : p));
      setLineup(prev => {
        const newLineup = { ...prev };
        Object.keys(newLineup).forEach(slotId => {
          if (newLineup[slotId].player?.id === editedPlayer.id) {
            newLineup[slotId].player = editedPlayer;
          }
        });
        return newLineup;
      });
      onClose();
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto p-1">
        <div className="bg-white rounded-lg w-full max-w-md my-2 flex flex-col shadow-xl max-h-[95vh]">
          <div className="bg-gray-700 text-white p-2 flex justify-between items-center flex-shrink-0 rounded-t-lg">
            <input 
              type="text"
              value={editedPlayer.name}
              onChange={(e) => updatePlayer('name', e.target.value)}
              className="bg-gray-600 text-white text-xs font-semibold px-2 py-1 rounded outline-none flex-1 mr-2"
              placeholder="Player name"
            />
            <button onClick={onClose} className="hover:bg-gray-600 p-1 rounded flex-shrink-0">
              <X className="w-4 h-4" />
            </button>
          </div>
          
          <div className="p-2 space-y-1.5 overflow-y-auto flex-1 min-h-0">
            {/* Copy Skills Dropdown */}
            <div className="bg-yellow-50 border border-yellow-200 rounded p-2">
              <label className="text-xs font-semibold text-gray-700 block mb-1">Copy Skills From Player</label>
              <select
                value={copyFromPlayerId}
                onChange={(e) => copySkillsFrom(e.target.value)}
                className="w-full px-2 py-1 border rounded text-sm"
              >
                <option value="">-- Select Player --</option>
                {players.filter(p => p.id !== editedPlayer.id).map(p => (
                  <option key={p.id} value={p.id}>{p.name}</option>
                ))}
              </select>
            </div>

            {editedPlayer.personality && (
              <div className="bg-blue-50 p-2 rounded">
                <textarea
                  value={editedPlayer.personality}
                  onChange={(e) => updatePlayer('personality', e.target.value)}
                  className="w-full text-xs text-gray-700 bg-transparent outline-none resize-none"
                  rows="2"
                />
              </div>
            )}

            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Age (years)</label>
                <input
                  type="number"
                  min="15"
                  max="50"
                  value={editedPlayer.age.years}
                  onChange={(e) => updateAge('years', parseInt(e.target.value))}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Age (days)</label>
                <input
                  type="number"
                  min="0"
                  max="111"
                  value={editedPlayer.age.days}
                  onChange={(e) => updateAge('days', parseInt(e.target.value))}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">TSI</label>
                <input
                  type="number"
                  min="0"
                  value={editedPlayer.tsi}
                  onChange={(e) => updatePlayer('tsi', parseInt(e.target.value))}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Specialty</label>
                <select
                  value={editedPlayer.specialty}
                  onChange={(e) => updatePlayer('specialty', e.target.value)}
                  className="w-full px-2 py-1 border rounded text-sm"
                >
                  <option>None</option>
                  <option>Technical</option>
                  <option>Quick</option>
                  <option>Powerful</option>
                  <option>Unpredictable</option>
                  <option>Head</option>
                  <option>Resilient</option>
                  <option>Support</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Form</label>
                <input
                  type="number"
                  min="0.1"
                  max="8.0"
                  step="0.1"
                  value={typeof editedPlayer.form === 'number' ? editedPlayer.form : 5}
                  onChange={(e) => {
                    const val = parseFloat(e.target.value);
                    if (!isNaN(val) && val >= 0.1 && val <= 8.0) {
                      updatePlayer('form', val);
                    }
                  }}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Stamina</label>
                <input
                  type="number"
                  min="0.1"
                  max="9.4"
                  step="0.1"
                  value={typeof editedPlayer.stamina === 'number' ? editedPlayer.stamina : 5}
                  onChange={(e) => {
                    const val = parseFloat(e.target.value);
                    if (!isNaN(val) && val >= 0.1 && val <= 9.4) {
                      updatePlayer('stamina', val);
                    }
                  }}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Experience</label>
                <input
                  type="number"
                  min="0"
                  max="50"
                  step="0.1"
                  value={editedPlayer.experience || 5}
                  onChange={(e) => {
                    const val = parseFloat(e.target.value);
                    if (!isNaN(val) && val >= 0 && val <= 50) {
                      updatePlayer('experience', val);
                    }
                  }}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div>
                <label className="text-xs font-semibold text-gray-700 block mb-1">Loyalty</label>
                <input
                  type="number"
                  min="0"
                  max="20"
                  step="0.1"
                  value={editedPlayer.loyalty ?? 0}
                  onChange={(e) => {
                    const val = parseFloat(e.target.value);
                    if (!isNaN(val) && val >= 0 && val <= 20) {
                      updatePlayer('loyalty', val);
                    }
                  }}
                  className="w-full px-2 py-1 border rounded text-sm"
                />
              </div>
              <div className="col-span-2">
                <label className="text-xs font-semibold text-gray-700 block mb-1">Homegrown</label>
                <button
                  onClick={() => updatePlayer('homegrown', !editedPlayer.homegrown)}
                  className="flex items-center gap-2 px-3 py-1 border rounded hover:bg-gray-50"
                >
                  <Heart 
                    className={`w-5 h-5 ${editedPlayer.homegrown ? 'fill-red-500 text-red-500' : 'text-gray-400'}`}
                  />
                  <span className={`text-sm ${editedPlayer.homegrown ? 'text-red-600 font-semibold' : 'text-gray-500'}`}>
                    {editedPlayer.homegrown ? 'Homegrown Player' : 'Not Homegrown'}
                  </span>
                </button>
              </div>
            </div>

            <div className="border-t pt-3 space-y-2">
              <h3 className="font-semibold text-gray-900 text-sm mb-2">Skills</h3>
              {Object.entries(editedPlayer.skills).map(([skill, data]) => (
                <div key={skill} className="flex justify-between items-center py-1 border-b">
                  <span className="text-xs font-medium text-gray-700 capitalize w-24">
                    {skill === 'setPieces' ? 'Set Pieces' : skill}
                  </span>
                  <div className="flex items-center gap-2">
                    <span className={`text-xs font-semibold ${getSkillColor(data.level)} w-32 text-right`}>
                      {data.level}
                    </span>
                    <input
                      type="number"
                      min="0"
                      max="23"
                      step="0.1"
                      value={data.value}
                      onChange={(e) => updateSkill(skill, e.target.value)}
                      className="w-16 px-2 py-1 border rounded text-sm text-right"
                    />
                  </div>
                </div>
              ))}
            </div>

            <div className="flex gap-2 pt-2">
              <button 
                onClick={handleSave}
                className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 font-semibold text-sm"
              >
                Save
              </button>
              <button 
                onClick={onClose}
                className="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500 font-semibold text-sm"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">
        
        <div className="lg:col-span-2 space-y-4">
          <div className="bg-green-700 text-white p-3 rounded-t-lg flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Users className="w-5 h-5" />
              <span className="font-semibold">hattriX Simulation <span className="text-sm italic font-normal">(by IanMajor)</span></span>
            </div>
            <div className="flex gap-2">
              <button 
                onClick={downloadData}
                className="p-1 hover:bg-green-600 rounded"
                title="Download lineup data"
              >
                <Download className="w-4 h-4" />
              </button>
              <label className="p-1 hover:bg-green-600 rounded cursor-pointer" title="Upload lineup data">
                <Upload className="w-4 h-4" />
                <input
                  type="file"
                  accept=".json"
                  onChange={uploadData}
                  className="hidden"
                />
              </label>
            </div>
          </div>

          <div className="bg-gray-700 p-4 rounded-b-lg">
            <div className="relative bg-gradient-to-b from-green-600 to-green-700 rounded-lg overflow-hidden flex" style={{ height: '600px' }}>
              
              <div className="relative w-12 flex-shrink-0 flex items-center justify-center py-8">
                <div 
                  id="tactic-slider"
                  className="relative h-full w-full flex flex-col items-center justify-between cursor-pointer"
                  onMouseDown={handleSliderMouseDown}
                >
                  <div className="absolute inset-y-0 left-1/2 transform -translate-x-1/2 w-1 bg-yellow-400 rounded-full shadow-md pointer-events-none"></div>
                  
                  <div 
                    className="absolute left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-full w-10 h-10 shadow-lg border-2 border-yellow-400 z-10 pointer-events-none flex items-center justify-center"
                    style={{ top: `${((tacticLevel + 100) / 200) * 100}%` }}
                  >
                    {tacticLevel !== 0 && (
                      <span className="text-[10px] font-bold text-gray-800">
                        {tacticLevel > 0 ? `+${tacticLevel}` : tacticLevel}%
                      </span>
                    )}
                  </div>
                </div>
              </div>

              <div className="relative flex-1">
                <div className="absolute inset-0">
                  <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-white opacity-30"></div>
                  <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-24 h-24 border-2 border-white opacity-30 rounded-full"></div>
                  <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-48 h-20 border-2 border-white border-t-0 opacity-30"></div>
                  <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-48 h-20 border-2 border-white border-b-0 opacity-30"></div>
                </div>

                {Object.entries(lineup).map(([slotId, data]) => {
                  // Definiere welche Positionen Orders haben können
                  const canHaveOrder = data.player && (
                    slotId === 'slot-wb-1' || // Linker WB
                    slotId === 'slot-wb-2' || // Rechter WB
                    slotId === 'slot-cd-1' || // Linker CD
                    slotId === 'slot-cd-2' || // Zentraler CD
                    slotId === 'slot-cd-3' || // Rechter CD
                    slotId === 'slot-cm-1' || // Linker IM
                    slotId === 'slot-cm-2' || // Zentraler IM
                    slotId === 'slot-cm-3' || // Rechter IM
                    slotId === 'slot-w-1' ||  // Linker Flügel
                    slotId === 'slot-w-2' ||  // Rechter Flügel
                    slotId === 'slot-fw-1' || // Linker FW
                    slotId === 'slot-fw-2' || // Zentraler FW
                    slotId === 'slot-fw-3'    // Rechter FW
                  );
                  
                  const currentOrder = playerOrders[slotId];
                  const isLeftWB = slotId === 'slot-wb-1';
                  const isRightWB = slotId === 'slot-wb-2';
                  const isLeftCD = slotId === 'slot-cd-1';
                  const isCentralCD = slotId === 'slot-cd-2';
                  const isRightCD = slotId === 'slot-cd-3';
                  const isLeftIM = slotId === 'slot-cm-1';
                  const isRightIM = slotId === 'slot-cm-3';
                  const isCentralIM = slotId === 'slot-cm-2';
                  const isLeftWing = slotId === 'slot-w-1';
                  const isRightWing = slotId === 'slot-w-2';
                  const isLeftFW = slotId === 'slot-fw-1';
                  const isRightFW = slotId === 'slot-fw-3';
                  const isCentralFW = slotId === 'slot-fw-2';
                  
                  return (
                  <div
                    key={slotId}
                    className="absolute transform -translate-x-1/2 -translate-y-1/2"
                    style={{ left: `${data.x}%`, top: `${data.y}%` }}
                    onDragOver={(e) => e.preventDefault()}
                    onDrop={() => handleDrop(slotId)}
                  >
                    {data.player ? (
                      <div 
                        className="relative group cursor-move"
                        draggable={true}
                        onDragStart={(e) => {
                          e.stopPropagation();
                          handleDragStart(data.player, slotId);
                        }}
                        onDragEnd={(e) => e.stopPropagation()}
                      >
                        <div className="flex flex-col items-center">
                          <div className="bg-gray-800 rounded-full w-16 h-16 flex items-center justify-center border-2 border-white shadow-lg relative">
                            <Shirt className="w-8 h-8 text-white" />
                            {/* Specialty Icon - links oben */}
                            {data.player.specialty && data.player.specialty !== 'None' && getSpecialtyIcon(data.player.specialty) && (
                              <div 
                                className={`absolute -top-1 -left-1 ${getSpecialtyColor(data.player.specialty)} rounded-full w-6 h-6 flex items-center justify-center border border-white font-bold text-xs text-white`}
                                title={data.player.specialty}
                              >
                                {getSpecialtyIcon(data.player.specialty)}
                              </div>
                            )}
                            {/* Order Arrow - rechts oben */}
                            {canHaveOrder && currentOrder && currentOrder !== 'N' && (
                              <div className={`absolute -top-1 -right-1 bg-gray-900 rounded-full w-6 h-6 flex items-center justify-center border border-white ${getOrderColor(currentOrder)} font-bold text-lg`}>
                                {getOrderArrow(currentOrder, slotId)}
                              </div>
                            )}
                          </div>
                          <div className="bg-black bg-opacity-70 text-white text-xs px-2 py-0.5 rounded mt-1 font-semibold">
                            {data.player.name}
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            handleRemovePlayer(slotId);
                          }}
                          className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10"
                        >
                          <X className="w-3 h-3" />
                        </button>
                        
                        {/* Arrow Direction Buttons */}
                        {canHaveOrder && (
                          <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                            <div className="relative w-full h-full pointer-events-auto">
                              {/* Defensive Arrow - oben (für WB, IM, W, FW, nicht für CD) */}
                              {(isLeftWB || isRightWB || isLeftIM || isRightIM || isCentralIM || isLeftWing || isRightWing || isLeftFW || isRightFW || isCentralFW) && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setPlayerOrder(slotId, currentOrder === 'Def' ? 'N' : 'Def');
                                  }}
                                  className={`absolute left-1/2 -translate-x-1/2 -top-12 w-12 h-12 rounded-full transition-all ${
                                    currentOrder === 'Def' 
                                      ? 'bg-yellow-400 text-gray-900 shadow-lg scale-110' 
                                      : 'bg-black bg-opacity-40 text-yellow-400 hover:bg-opacity-60 border-2 border-yellow-400'
                                  }`}
                                  title="Defensive"
                                  style={{ 
                                    textShadow: '0 0 2px currentColor, 0 0 2px currentColor',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1'
                                  }}
                                >
                                  <span className="text-5xl font-black" style={{ display: 'block', marginTop: '-4px' }}>↑</span>
                                </button>
                              )}
                              
                              {/* Offensive Arrow - unten (für WB, CD, IM, W, nicht für FW) */}
                              {(isLeftWB || isRightWB || isLeftCD || isCentralCD || isRightCD || isLeftIM || isRightIM || isCentralIM || isLeftWing || isRightWing) && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setPlayerOrder(slotId, currentOrder === 'Off' ? 'N' : 'Off');
                                  }}
                                  className={`absolute left-1/2 -translate-x-1/2 top-20 w-12 h-12 rounded-full transition-all ${
                                    currentOrder === 'Off' 
                                      ? 'bg-yellow-400 text-gray-900 shadow-lg scale-110' 
                                      : 'bg-black bg-opacity-40 text-yellow-400 hover:bg-opacity-60 border-2 border-yellow-400'
                                  }`}
                                  title="Offensive"
                                  style={{ 
                                    textShadow: '0 0 2px currentColor, 0 0 2px currentColor',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1'
                                  }}
                                >
                                  <span className="text-5xl font-black" style={{ display: 'block', marginTop: '-4px' }}>↓</span>
                                </button>
                              )}
                              
                              {/* Toward Wing/Middle Arrow - seitlich */}
                              {/* Für WB: nach innen zur Mitte - auf der INNEREN Seite positioniert */}
                              {/* Für äußere CD: nach außen zum Flügel */}
                              {/* Für äußere IM: nach außen zum Flügel */}
                              {/* Für Flügel: nach innen zur Mitte - auf der INNEREN Seite positioniert */}
                              {/* Für äußere FW: nach außen zum Flügel */}
                              {(isLeftWB || isRightWB || isLeftCD || isRightCD || isLeftIM || isRightIM || isLeftWing || isRightWing || isLeftFW || isRightFW) && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    // WB und W verwenden TM (Toward Middle)
                                    // CD, IM, FW verwenden TW (Toward Wing)
                                    const orderType = (isLeftWB || isRightWB || isLeftWing || isRightWing) ? 'TM' : 'TW';
                                    const isActive = currentOrder === orderType;
                                    setPlayerOrder(slotId, isActive ? 'N' : orderType);
                                  }}
                                  className={`absolute top-1/2 -translate-y-1/2 w-12 h-12 rounded-full transition-all ${
                                    ((isLeftWB || isRightWB || isLeftWing || isRightWing) && currentOrder === 'TM') || 
                                    (!(isLeftWB || isRightWB || isLeftWing || isRightWing) && currentOrder === 'TW')
                                      ? 'bg-yellow-400 text-gray-900 shadow-lg scale-110' 
                                      : 'bg-black bg-opacity-40 text-yellow-400 hover:bg-opacity-60 border-2 border-yellow-400'
                                  } ${
                                    (isLeftCD || isLeftIM || isLeftFW) ? '-left-12' : 
                                    (isRightCD || isRightIM || isRightFW) ? '-right-12' :
                                    (isLeftWB || isLeftWing) ? '-right-12' : // Linker WB/W: Pfeil rechts (zur Mitte)
                                    '-left-12' // Rechter WB/W: Pfeil links (zur Mitte)
                                  }`}
                                  title={(isLeftWB || isRightWB || isLeftWing || isRightWing) ? "Toward Middle" : "Toward Wing"}
                                  style={{ 
                                    textShadow: '0 0 2px currentColor, 0 0 2px currentColor',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    lineHeight: '1'
                                  }}
                                >
                                  <span className="text-5xl font-black" style={{ display: 'block', marginTop: '-4px' }}>
                                    {(isLeftCD || isLeftIM || isLeftFW) ? '←' : 
                                     (isRightCD || isRightIM || isRightFW) ? '→' : 
                                     (isLeftWB || isLeftWing) ? '→' : '←'}
                                  </span>
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="flex flex-col items-center">
                        <div className="bg-white bg-opacity-30 rounded-full w-16 h-16 flex items-center justify-center border-2 border-white border-dashed shadow-lg">
                          <Users className="w-8 h-8 text-white opacity-50" />
                        </div>
                        <div className="bg-black bg-opacity-50 text-white text-xs px-2 py-0.5 rounded mt-1">
                          {data.position}
                        </div>
                      </div>
                    )}
                  </div>
                )})}


                <div className="absolute bottom-4 right-4 bg-green-800 bg-opacity-90 text-white rounded-lg shadow-lg text-xs">
                  <div className="flex flex-col gap-px bg-green-900 p-px">
                    <div className="grid grid-cols-3 gap-px">
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.rightDefense.toFixed(2)}</div>
                      </div>
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.centralDefense.toFixed(2)}</div>
                      </div>
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.leftDefense.toFixed(2)}</div>
                      </div>
                    </div>
                    
                    <div className="bg-green-800 px-2 py-1 text-center">
                      <div className="text-xs font-bold">{ratings.midfield.toFixed(2)}</div>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-px">
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.rightAttack.toFixed(2)}</div>
                      </div>
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.centralAttack.toFixed(2)}</div>
                      </div>
                      <div className="bg-green-800 px-2 py-1 text-center">
                        <div className="text-xs font-bold">{ratings.leftAttack.toFixed(2)}</div>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-green-900 text-center py-0.5 text-xs rounded-b-lg">
                    Tactics: {selectedTactic}
                  </div>
                </div>

                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-green-800 text-white px-4 py-2 rounded-lg font-bold text-lg">
                  {calculateCurrentFormation() || ''}
                </div>

                <div className="absolute left-2 top-4 bg-gray-700 bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                  Defensive
                </div>
                <div className="absolute left-2 bottom-4 bg-gray-700 bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                  Offensive
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4 mt-4">
              <div className="bg-green-700 p-3 rounded">
                <label className="text-white text-sm font-semibold mb-2 block">Tactics</label>
                <select 
                  className="w-full px-3 py-2 rounded border-none"
                  value={selectedTactic}
                  onChange={(e) => setSelectedTactic(e.target.value)}
                >
                  <option>Normal</option>
                  <option>Pressing</option>
                  <option>Counter-attacks</option>
                  <option>Attack in the middle</option>
                  <option>Attack on wings</option>
                  <option>Play creatively</option>
                  <option>Long shots</option>
                </select>
              </div>
              <div className="bg-green-700 p-3 rounded">
                <label className="text-white text-sm font-semibold mb-2 block">Team Attitude</label>
                <select 
                  className="w-full px-3 py-2 rounded border-none"
                  value={teamAttitude}
                  onChange={(e) => setTeamAttitude(e.target.value)}
                >
                  <option>Play it cool</option>
                  <option>Normal</option>
                  <option>Match of the Season</option>
                </select>
              </div>
            </div>

            <div className="bg-green-700 p-4 rounded-lg mt-4">
              <div className="flex items-center gap-2 mb-4">
                <Settings className="w-5 h-5 text-white" />
                <h3 className="text-white font-semibold">Sandbox Mode</h3>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">Weather</label>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setSelectedWeather('rainy')}
                      className={`p-2 rounded flex items-center justify-center ${selectedWeather === 'rainy' ? 'bg-blue-600 border-2 border-white' : 'bg-white border-2 border-gray-300'}`}
                      title="Rainy"
                    >
                      <span className="text-2xl">⛈️</span>
                    </button>
                    <button 
                      onClick={() => setSelectedWeather('cloudy')}
                      className={`p-2 rounded flex items-center justify-center ${selectedWeather === 'cloudy' ? 'bg-blue-600 border-2 border-white' : 'bg-white border-2 border-gray-300'}`}
                      title="Cloudy"
                    >
                      <span className="text-2xl">☁️</span>
                    </button>
                    <button 
                      onClick={() => setSelectedWeather('partly-cloudy')}
                      className={`p-2 rounded flex items-center justify-center ${selectedWeather === 'partly-cloudy' ? 'bg-blue-600 border-2 border-white' : 'bg-white border-2 border-gray-300'}`}
                      title="Partly Cloudy"
                    >
                      <span className="text-2xl">⛅</span>
                    </button>
                    <button 
                      onClick={() => setSelectedWeather('sunny')}
                      className={`p-2 rounded flex items-center justify-center ${selectedWeather === 'sunny' ? 'bg-blue-600 border-2 border-white' : 'bg-white border-2 border-gray-300'}`}
                      title="Sunny"
                    >
                      <span className="text-2xl">☀️</span>
                    </button>
                  </div>
                </div>

                <div>
                  <label className="text-white text-sm font-semibold block mb-2">Venue</label>
                  <select 
                    className="w-full px-3 py-2 rounded border-none"
                    value={selectedVenue}
                    onChange={(e) => setSelectedVenue(e.target.value)}
                  >
                    <option>Away</option>
                    <option>Home</option>
                    <option>Neutral</option>
                  </select>
                </div>

                <div>
                  <label className="text-white text-sm font-semibold block mb-2">Team spirit</label>
                  <input 
                    type="number"
                    min="0"
                    max="11"
                    step="0.1"
                    className="w-full px-3 py-2 rounded border-none"
                    value={selectedTeamSpirit}
                    onChange={(e) => {
                      const val = parseFloat(e.target.value);
                      if (!isNaN(val) && val >= 0 && val <= 11) {
                        setSelectedTeamSpirit(val);
                      }
                    }}
                  />
                </div>

                <div>
                  <label className="text-white text-sm font-semibold block mb-2">Confidence</label>
                  <input 
                    type="number"
                    min="0"
                    max="11"
                    step="0.1"
                    className="w-full px-3 py-2 rounded border-none"
                    value={selectedConfidence}
                    onChange={(e) => {
                      const val = parseFloat(e.target.value);
                      if (!isNaN(val) && val >= 0 && val <= 11) {
                        setSelectedConfidence(val);
                      }
                    }}
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="space-y-4">
          <div className="bg-green-700 text-white p-3 rounded-t-lg flex items-center gap-2">
            <Users className="w-5 h-5" />
            <span className="font-semibold">Players</span>
          </div>
          
          <div className="bg-white rounded-b-lg shadow-lg max-h-[600px] overflow-y-auto">
            <div className="divide-y">
              {players.map((player) => (
                <div 
                  key={player.id} 
                  className="p-3 hover:bg-gray-50 flex items-center justify-between group"
                >
                  <div 
                    className="flex items-center gap-3 flex-1 cursor-move"
                    draggable
                    onDragStart={() => handleDragStart(player, null)}
                  >
                    <Shirt className="w-4 h-4 text-gray-600" />
                    <span className="text-sm font-semibold">{player.name}</span>
                    {player.specialty && player.specialty !== 'None' && getSpecialtyIcon(player.specialty) && (
                      <div 
                        className={`w-5 h-5 rounded-full ${getSpecialtyColor(player.specialty)} text-white text-[10px] font-bold flex items-center justify-center`}
                        title={player.specialty}
                      >
                        {getSpecialtyIcon(player.specialty)}
                      </div>
                    )}
                    <span className="text-xs text-gray-500">{player.age.years}y</span>
                    {getBestPosition(player) && (
                      <div 
                        className="w-6 h-6 rounded-full bg-gray-700 text-white text-[10px] font-bold flex items-center justify-center"
                        title={`Best position: ${getBestPosition(player)}`}
                      >
                        {getBestPosition(player)}
                      </div>
                    )}
                  </div>
                  
                  {/* Slot Selection Dropdown */}
                  <select
                    onChange={(e) => {
                      if (e.target.value) {
                        const toSlotId = e.target.value;
                        
                        // Finde ob Spieler bereits auf dem Feld ist
                        const fromSlotId = Object.keys(lineup).find(
                          slotId => lineup[slotId].player?.id === player.id
                        );
                        
                        setLineup(prev => {
                          const newLineup = { ...prev };
                          
                          // Speichere den Spieler der auf dem Ziel-Slot ist (falls vorhanden)
                          const playerOnTargetSlot = prev[toSlotId]?.player;
                          
                          // Wenn Spieler bereits auf dem Feld ist
                          if (fromSlotId && fromSlotId !== toSlotId) {
                            // Wenn auf dem Ziel-Slot ein Spieler ist, tausche die Plätze
                            if (playerOnTargetSlot) {
                              newLineup[fromSlotId] = {
                                ...prev[fromSlotId],
                                player: playerOnTargetSlot
                              };
                            } else {
                              // Sonst entferne vom alten Slot
                              newLineup[fromSlotId] = {
                                ...prev[fromSlotId],
                                player: null
                              };
                            }
                          }
                          
                          // Setze Spieler auf die neue Position
                          newLineup[toSlotId] = {
                            ...prev[toSlotId],
                            player: player
                          };
                          
                          return newLineup;
                        });
                        
                        e.target.value = ''; // Reset dropdown
                      }
                    }}
                    className="text-xs px-2 py-1 border border-gray-300 rounded hover:border-blue-500 focus:outline-none focus:border-blue-500 bg-white"
                    defaultValue=""
                  >
                    <option value="" disabled>Assign to...</option>
                    <option value="slot-gk-1">GK</option>
                    <optgroup label="Defenders">
                      <option value="slot-wb-1">Left WB</option>
                      <option value="slot-cd-1">Left CD</option>
                      <option value="slot-cd-2">Central CD</option>
                      <option value="slot-cd-3">Right CD</option>
                      <option value="slot-wb-2">Right WB</option>
                    </optgroup>
                    <optgroup label="Midfielders">
                      <option value="slot-w-1">Left W</option>
                      <option value="slot-cm-1">Left IM</option>
                      <option value="slot-cm-2">Central IM</option>
                      <option value="slot-cm-3">Right IM</option>
                      <option value="slot-w-2">Right W</option>
                    </optgroup>
                    <optgroup label="Forwards">
                      <option value="slot-fw-1">Left FW</option>
                      <option value="slot-fw-2">Central FW</option>
                      <option value="slot-fw-3">Right FW</option>
                    </optgroup>
                  </select>
                  
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setEditingPlayer(player)}
                      className="p-1 hover:bg-blue-100 rounded opacity-0 group-hover:opacity-100 transition-opacity"
                      title="Edit player"
                    >
                      <Edit2 className="w-4 h-4 text-blue-600" />
                    </button>
                    <button
                      onClick={() => deletePlayer(player.id)}
                      className="p-1 hover:bg-red-100 rounded opacity-0 group-hover:opacity-100 transition-opacity"
                      title="Delete player"
                    >
                      <Trash2 className="w-4 h-4 text-red-600" />
                    </button>
                  </div>
                </div>
              ))}
              
              <button
                onClick={addNewPlayer}
                className="w-full p-4 hover:bg-gray-50 flex items-center justify-center gap-2 text-green-600 font-semibold border-t-2 border-green-200"
              >
                <Plus className="w-5 h-5" />
                <span>Add New Player</span>
              </button>
            </div>
          </div>

          <div className="bg-green-700 p-4 rounded-lg shadow-lg">
            <h3 className="text-white font-semibold mb-3 flex items-center gap-2">
              <Upload className="w-5 h-5" />
              Import / Export
            </h3>
            
            <div className="space-y-3">
              <div>
                <label className="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded cursor-pointer inline-flex items-center gap-2 w-full justify-center">
                  <Upload className="w-4 h-4" />
                  <span>Upload Players</span>
                  <input
                    type="file"
                    accept=".tsv,.txt,.csv"
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                </label>
              </div>

              <button
                onClick={exportPlayers}
                className="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded inline-flex items-center gap-2 w-full justify-center"
              >
                <Download className="w-4 h-4" />
                <span>Download Players</span>
              </button>

              {uploadError && (
                <div className="bg-red-500 text-white text-sm p-2 rounded">
                  {uploadError}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {editingPlayer && (
        <PlayerEditor 
          player={editingPlayer} 
          onClose={() => setEditingPlayer(null)} 
        />
      )}
    </div>
  );
};

export default LineupSimulator;
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LineupSimulator />);
    </script>
</body>
</html>
